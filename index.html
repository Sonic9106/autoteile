<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeileDoc</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Tesseract.js Bibliothek für die optische Zeichenerkennung (OCR) -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>

    <!-- Modal für die Kameraaufforderung und Live-Scan -->
    <div id="camera-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div class="modal-body">
                <h2>HSN/TSN scannen</h2>
                <p>Bitte halten Sie Ihre Kamera über den Fahrzeugschein</p>
                <div class="video-container">
                    <!-- Video-Element für den Live-Kamera-Stream -->
                    <video id="camera-stream" class="camera-stream" autoplay playsinline></video>
                    <!-- Unsichtbares Canvas-Element für die Bildverarbeitung -->
                    <canvas id="camera-canvas" style="display: none;"></canvas>
                </div>
                <div id="scan-feedback">
                    <p id="status-message">Kamera wird geladen...</p>
                    <div id="progress-bar-container" class="progress-bar-container">
                        <div id="progress-bar" class="progress-bar"></div>
                    </div>
                    <!-- Bereich für die erkannten Daten -->
                    <pre id="recognized-text"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Fester Header -->
    <header class="header">
        <h1 class="logo">TeileDoc</h1>
        <button class="login-btn">Login / Registrieren</button>
    </header>

    <!-- Hauptinhalt der Seite -->
    <main class="main-content">
        <!-- Call-to-Action-Button für den Fahrzeugschein -->
        <div class="search-cta-container">
            <button id="cta-button" class="search-cta-btn">
                <i class="fas fa-camera"></i>
                <span>Fahrzeugschein abfotografieren</span>
            </button>
        </div>

        <!-- Manuelle Suchleiste -->
        <div class="manual-search-container">
            <input type="text" class="manual-search-input" placeholder="Manuelle Suche">
        </div>
    </main>

    <script>
        const ctaButton = document.getElementById('cta-button');
        const modal = document.getElementById('camera-modal');
        const closeButton = document.getElementsByClassName('close-button')[0];
        const video = document.getElementById('camera-stream');
        const canvas = document.getElementById('camera-canvas');
        const context = canvas.getContext('2d');
        const statusMessage = document.getElementById('status-message');
        const progressBar = document.getElementById('progress-bar');
        const recognizedText = document.getElementById('recognized-text');
        
        let worker; // Tesseract Worker
        let isProcessing = false;

        // Öffnet das Modal und startet die Kamera
        ctaButton.onclick = function() {
            modal.style.display = "flex";
            startCameraAndOCR();
        }

        // Schließt das Modal-Fenster
        closeButton.onclick = function() {
            modal.style.display = "none";
            stopCameraAndOCR();
        }

        // Schließt das Modal, wenn außerhalb geklickt wird
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
                stopCameraAndOCR();
            }
        }

        // Hauptfunktion zum Starten der Kamera und OCR
        async function startCameraAndOCR() {
            recognizedText.innerText = 'HSN: Nicht gefunden\nTSN: Nicht gefunden';
            statusMessage.innerText = 'Kamera wird gestartet...';
            progressBar.style.width = '0%';
            
            try {
                // Kamera-Stream starten (hintere Kamera)
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment'
                    }
                });
                video.srcObject = stream;

                video.onloadedmetadata = () => {
                    video.play();
                    // Live-Scan-Prozess starten, sobald das Video geladen ist
                    startScanLoop();
                };
            } catch (err) {
                console.error("Fehler beim Kamerazugriff:", err);
                statusMessage.innerHTML = `<i class="fas fa-exclamation-triangle"></i><p>Kamerazugriff fehlgeschlagen. Bitte HTTPS oder Online-Hosting verwenden.</p>`;
            }
        }
        
        // OCR-Worker laden
        async function loadWorker() {
            statusMessage.innerText = 'Lade OCR-Modul...';
            progressBar.style.width = '10%';
            worker = await Tesseract.createWorker({
                logger: m => {
                    if (m.progress) {
                        const progressPercent = Math.round(m.progress * 100);
                        if (m.status === 'recognizing text') {
                           statusMessage.innerText = 'Scanne Fahrzeugschein...';
                           progressBar.style.width = `${50 + progressPercent / 2}%`;
                        } else if (m.status === 'loading tesseract core' || m.status === 'initializing api') {
                           statusMessage.innerText = 'Lade OCR-Modul...';
                           progressBar.style.width = `${progressPercent * 0.5}%`;
                        }
                    }
                }
            });
            
            await worker.loadLanguage('deu'); // Lädt Deutsch
            await worker.initialize('deu');
            statusMessage.innerText = 'Bereit zum Scannen.';
            progressBar.style.width = '100%';
        }
        
        // Startet den kontinuierlichen Scan-Prozess
        async function startScanLoop() {
            if (!worker) {
                await loadWorker();
            }
            
            scanLoop();
        }
        
        // Scan-Schleife für die Live-Erkennung
        async function scanLoop() {
            if (isProcessing) {
                // Wartet, bis der vorherige Scan abgeschlossen ist
                requestAnimationFrame(scanLoop);
                return;
            }
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                isProcessing = true;
                
                // Canvas-Größe anpassen und aktuellen Video-Frame zeichnen
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // OCR auf dem Canvas-Bild ausführen
                const { data: { text } } = await worker.recognize(canvas);
                
                // Regex, um HSN (4 Ziffern) und TSN (3 Ziffern + 5 beliebige Zeichen) zu finden
                const hsnRegex = /(?:HSN|2\.1)\s*(\d{4})/;
                const tsnRegex = /(?:TSN|2\.2)\s*([a-zA-Z0-9]{3}[a-zA-Z0-9]{5})/;
                
                const hsnMatch = text.match(hsnRegex);
                const tsnMatch = text.match(tsnRegex);

                const hsn = hsnMatch ? hsnMatch[1] : 'Nicht gefunden';
                const tsn = tsnMatch ? tsnMatch[1] : 'Nicht gefunden';

                // Nur die extrahierten Daten anzeigen
                recognizedText.innerText = `HSN: ${hsn}\nTSN: ${tsn}`;
                
                isProcessing = false;
            }
            
            // Schleife fortsetzen
            requestAnimationFrame(scanLoop);
        }

        // Stoppt den Kamera-Stream und Tesseract Worker
        function stopCameraAndOCR() {
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            if (worker) {
                worker.terminate();
                worker = null;
            }
        }
    </script>
</body>
</html>
