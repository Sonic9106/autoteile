<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeileDoc</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Paddle.js Bibliothek für die optische Zeichenerkennung (OCR) -->
    <script src="https://unpkg.com/@paddlejs/paddlejs-ocr/dist/paddlejs-ocr.js"></script>
</head>
<body>

    <!-- Modal für die Kameraaufforderung und Live-Scan -->
    <div id="camera-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div class="modal-body">
                <h2>HSN/TSN scannen</h2>
                <!-- Auswahl der Scan-Methode -->
                <div id="method-selection">
                    <button id="live-scan-btn" class="modal-btn">
                        <i class="fas fa-camera"></i> Live-Scan starten
                    </button>
                    <button id="upload-btn" class="modal-btn">
                        <i class="fas fa-upload"></i> Foto hochladen
                    </button>
                    <input type="file" id="file-input" accept="image/*" style="display: none;">
                </div>

                <!-- Bereich für den Live-Scan (initial versteckt) -->
                <div id="live-scan-container" class="hidden">
                    <button id="live-scan-back-btn" class="back-btn"><i class="fas fa-arrow-left"></i></button>
                    <p>Bitte halten Sie Ihre Kamera über den Fahrzeugschein</p>
                    <div class="video-container">
                        <video id="camera-stream" class="camera-stream" autoplay playsinline></video>
                        <div id="scan-box"></div>
                    </div>
                </div>

                <!-- Bereich für das Ergebnis und Feedback (initial versteckt) -->
                <div id="scan-feedback" class="hidden">
                    <button id="feedback-back-btn" class="back-btn"><i class="fas fa-arrow-left"></i></button>
                    <p id="status-message">Kamera wird geladen...</p>
                    <div id="progress-bar-container" class="progress-bar-container">
                        <div id="progress-bar" class="progress-bar"></div>
                    </div>
                    <pre id="recognized-text"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Fester Header -->
    <header class="header">
        <h1 class="logo">TeileDoc</h1>
        <button class="login-btn">Login / Registrieren</button>
    </header>

    <!-- Hauptinhalt der Seite -->
    <main class="main-content">
        <!-- Call-to-Action-Button für den Fahrzeugschein -->
        <div class="search-cta-container">
            <button id="cta-button" class="search-cta-btn">
                <i class="fas fa-camera"></i>
                <span>Fahrzeugschein abfotografieren</span>
            </button>
        </div>
    </main>

    <script>
        // DOM-Elemente
        const ctaButton = document.getElementById('cta-button');
        const modal = document.getElementById('camera-modal');
        const closeButton = document.getElementsByClassName('close-button')[0];
        const liveScanBtn = document.getElementById('live-scan-btn');
        const uploadBtn = document.getElementById('upload-btn');
        const liveScanBackBtn = document.getElementById('live-scan-back-btn');
        const feedbackBackBtn = document.getElementById('feedback-back-btn');
        const fileInput = document.getElementById('file-input');
        const liveScanContainer = document.getElementById('live-scan-container');
        const scanFeedback = document.getElementById('scan-feedback');
        const video = document.getElementById('camera-stream');
        const scanBox = document.getElementById('scan-box');
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        const statusMessage = document.getElementById('status-message');
        const progressBar = document.getElementById('progress-bar');
        const recognizedText = document.getElementById('recognized-text');
        
        let ocr;
        let isProcessing = false;
        let isLiveScan = false;
        let animationFrameId;

        // Initialisiert PaddleOCR
        async function loadOCRModel() {
            if (ocr) return; // Modell nur einmal laden
            statusMessage.innerText = 'Lade OCR-Modell...';
            progressBar.style.width = '10%';
            try {
                ocr = await paddlejs.ocr.init();
                statusMessage.innerText = 'Bereit zum Scannen.';
                progressBar.style.width = '100%';
            } catch (err) {
                console.error("Fehler beim Laden des OCR-Modells:", err);
                statusMessage.innerHTML = `<i class="fas fa-exclamation-triangle"></i><p>Fehler beim Laden des OCR-Modells.</p>`;
            }
        }

        // Öffnet das Modal
        ctaButton.onclick = function() {
            modal.style.display = "flex";
            document.getElementById('method-selection').classList.remove('hidden');
            liveScanContainer.classList.add('hidden');
            scanFeedback.classList.add('hidden');
            recognizedText.innerText = 'HSN: Nicht gefunden\nTSN: Nicht gefunden';
            loadOCRModel();
        }

        // Schließt das Modal-Fenster
        closeButton.onclick = function() {
            modal.style.display = "none";
            stopCamera();
        }

        // Schließt das Modal, wenn außerhalb geklickt wird
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
                stopCamera();
            }
        }
        
        // Klick auf Live-Scan starten
        liveScanBtn.onclick = function() {
            document.getElementById('method-selection').classList.add('hidden');
            liveScanContainer.classList.remove('hidden');
            scanFeedback.classList.remove('hidden');
            isLiveScan = true;
            startCameraAndScan();
        }

        // Klick auf Foto hochladen
        uploadBtn.onclick = function() {
            fileInput.click();
        }
        
        // Zurück-Buttons
        liveScanBackBtn.onclick = resetToMethodSelection;
        feedbackBackBtn.onclick = resetToMethodSelection;

        function resetToMethodSelection() {
            stopCamera();
            liveScanContainer.classList.add('hidden');
            scanFeedback.classList.add('hidden');
            document.getElementById('method-selection').classList.remove('hidden');
            recognizedText.innerText = 'HSN: Nicht gefunden\nTSN: Nicht gefunden';
            statusMessage.innerText = '';
            progressBar.style.width = '0%';
        }

        // Dateiauswahl verarbeiten
        fileInput.onchange = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('method-selection').classList.add('hidden');
            liveScanContainer.classList.add('hidden');
            scanFeedback.classList.remove('hidden');
            isLiveScan = false;
            
            // Zeige sofort den "Verarbeite"-Status an
            statusMessage.innerText = 'Bild wird verarbeitet...';
            progressBar.style.width = '0%';

            const reader = new FileReader();
            reader.onload = async function(e) {
                const img = new Image();
                img.onload = async () => {
                    // Canvas-Größe anpassen und Bild zeichnen
                    canvas.width = img.width;
                    canvas.height = img.height;
                    context.drawImage(img, 0, 0, img.width, img.height);
                    
                    // OCR auf dem statischen Bild ausführen
                    await runOCR(canvas);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // Hauptfunktion zum Starten der Kamera
        async function startCameraAndScan() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    startScanLoop();
                };
            } catch (err) {
                console.error("Fehler beim Kamerazugriff:", err);
                statusMessage.innerHTML = `<i class="fas fa-exclamation-triangle"></i><p>Kamerazugriff fehlgeschlagen. Bitte HTTPS oder Online-Hosting verwenden.</p>`;
            }
        }

        // Führt die OCR-Erkennung aus
        async function runOCR(image) {
            if (!ocr) {
                statusMessage.innerText = 'OCR-Modul wird geladen... Bitte warten.';
                return;
            }
            isProcessing = true;
            statusMessage.innerText = 'Scanne HSN & TSN...';
            progressBar.style.width = '50%';
            
            try {
                // PaddleOCR erkennt Textbereiche im Bild
                const res = await ocr.recognize(image);
                const fullText = res.map(item => item.text).join(' ');

                // RegEx-Muster für HSN/TSN
                const hsnRegex = /(?:HSN|2\.1)\s*(\d{4})/;
                const tsnRegex = /(?:TSN|2\.2)\s*([a-zA-Z0-9]{3}[a-zA-Z0-9]{5})/;
                
                const hsnMatch = fullText.match(hsnRegex);
                const tsnMatch = fullText.match(tsnRegex);

                const hsn = hsnMatch ? hsnMatch[1] : 'Nicht gefunden';
                const tsn = tsnMatch ? tsnMatch[1] : 'Nicht gefunden';

                recognizedText.innerText = `HSN: ${hsn}\nTSN: ${tsn}`;
                statusMessage.innerText = 'Scan abgeschlossen.';
                progressBar.style.width = '100%';
            } catch (err) {
                console.error("Fehler bei der OCR-Erkennung:", err);
                statusMessage.innerHTML = `<i class="fas fa-exclamation-triangle"></i><p>Fehler bei der Texterkennung.</p>`;
            } finally {
                isProcessing = false;
            }
        }
        
        // Scan-Schleife für die Live-Erkennung
        async function startScanLoop() {
            if (isProcessing || !isLiveScan) {
                animationFrameId = requestAnimationFrame(startScanLoop);
                return;
            }
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                isProcessing = true;
                
                // Koordinaten der Scanbox auf dem Video
                const boxRect = scanBox.getBoundingClientRect();
                const videoRect = video.getBoundingClientRect();
                const scaleX = video.videoWidth / videoRect.width;
                const scaleY = video.videoHeight / videoRect.height;

                const cropX = (boxRect.left - videoRect.left) * scaleX;
                const cropY = (boxRect.top - videoRect.top) * scaleY;
                const cropWidth = boxRect.width * scaleX;
                const cropHeight = boxRect.height * scaleY;

                canvas.width = cropWidth;
                canvas.height = cropHeight;
                context.drawImage(video, cropX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);
                
                await runOCR(canvas);
            }
            
            animationFrameId = requestAnimationFrame(startScanLoop);
        }

        // Stoppt den Kamera-Stream
        function stopCamera() {
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            isLiveScan = false;
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
        }
    </script>
</body>
</html>
